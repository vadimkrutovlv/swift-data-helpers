name: Backfill Versioned Documentation

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  resolve_versions:
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    outputs:
      stable_version: ${{ steps.resolve.outputs.stable_version }}
      versions_matrix: ${{ steps.matrix.outputs.versions_matrix }}
    steps:
      - uses: actions/checkout@v4
      - name: Resolve versions for backfill
        id: resolve
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          ./.github/scripts/ci/resolve_docs_versions.sh \
            --repository "${{ github.repository }}" \
            --manifest-path "${RUNNER_TEMP}/versions.json" \
            --max-versions "5" \
            --github-output "${GITHUB_OUTPUT}"
      - name: Prepare matrix payload
        id: matrix
        env:
          ALL_VERSIONS_JSON: ${{ steps.resolve.outputs.all_versions_json }}
        run: |
          if [ "${{ steps.resolve.outputs.has_versions }}" = "true" ]; then
            printf 'versions_matrix=%s\n' "${ALL_VERSIONS_JSON}" >> "${GITHUB_OUTPUT}"
          else
            echo 'versions_matrix=[]' >> "${GITHUB_OUTPUT}"
          fi

  deploy_versions:
    needs: resolve_versions
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(needs.resolve_versions.outputs.versions_matrix) }}
    uses: ./.github/workflows/docs-channel-deploy.yml
    with:
      channel: ${{ matrix.version }}
      source_ref: ${{ github.event_name == 'pull_request' && github.sha || 'main' }}
      max_versions: 5
    secrets: inherit

  deploy_stable:
    needs: resolve_versions
    if: ${{ needs.resolve_versions.outputs.stable_version != '' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository) }}
    uses: ./.github/workflows/docs-channel-deploy.yml
    with:
      channel: stable
      source_ref: ${{ github.event_name == 'pull_request' && github.sha || 'main' }}
      max_versions: 5
    secrets: inherit
